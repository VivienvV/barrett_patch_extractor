
<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_i9ogz79n8728-8>li:before{content:"-  "}.lst-kix_i9ogz79n8728-6>li:before{content:"-  "}.lst-kix_i9ogz79n8728-7>li:before{content:"-  "}ul.lst-kix_zd2jejnf7l80-5{list-style-type:none}ul.lst-kix_zd2jejnf7l80-6{list-style-type:none}ul.lst-kix_zd2jejnf7l80-7{list-style-type:none}ul.lst-kix_zd2jejnf7l80-8{list-style-type:none}.lst-kix_i9ogz79n8728-1>li:before{content:"-  "}ul.lst-kix_zd2jejnf7l80-0{list-style-type:none}ul.lst-kix_zd2jejnf7l80-1{list-style-type:none}.lst-kix_i9ogz79n8728-2>li:before{content:"-  "}.lst-kix_i9ogz79n8728-3>li:before{content:"-  "}ul.lst-kix_zd2jejnf7l80-2{list-style-type:none}ul.lst-kix_zd2jejnf7l80-3{list-style-type:none}.lst-kix_uudkrsvsf0zu-6>li:before{content:"-  "}ul.lst-kix_zd2jejnf7l80-4{list-style-type:none}.lst-kix_i9ogz79n8728-4>li:before{content:"-  "}.lst-kix_i9ogz79n8728-5>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-7>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-8>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-4>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-5>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-5>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-6>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-8>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-4>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-7>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-1>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-3>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-2>li:before{content:"-  "}.lst-kix_r3tj6hiinl4w-5>li:before{content:"-  "}.lst-kix_r3tj6hiinl4w-4>li:before{content:"-  "}.lst-kix_uudkrsvsf0zu-0>li:before{content:"-  "}ul.lst-kix_r3tj6hiinl4w-3{list-style-type:none}.lst-kix_r3tj6hiinl4w-6>li:before{content:"-  "}ul.lst-kix_r3tj6hiinl4w-4{list-style-type:none}ul.lst-kix_r3tj6hiinl4w-5{list-style-type:none}.lst-kix_r3tj6hiinl4w-7>li:before{content:"-  "}ul.lst-kix_r3tj6hiinl4w-6{list-style-type:none}.lst-kix_r3tj6hiinl4w-8>li:before{content:"-  "}ul.lst-kix_r3tj6hiinl4w-0{list-style-type:none}ul.lst-kix_r3tj6hiinl4w-1{list-style-type:none}ul.lst-kix_r3tj6hiinl4w-2{list-style-type:none}ul.lst-kix_r3tj6hiinl4w-7{list-style-type:none}ul.lst-kix_r3tj6hiinl4w-8{list-style-type:none}ul.lst-kix_i9ogz79n8728-1{list-style-type:none}ul.lst-kix_i9ogz79n8728-0{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-3{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-2{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-5{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-4{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-7{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-6{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-8{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-1{list-style-type:none}ul.lst-kix_kamoyoh6ff6i-0{list-style-type:none}.lst-kix_kamoyoh6ff6i-1>li:before{content:"-  "}.lst-kix_kamoyoh6ff6i-2>li:before{content:"-  "}.lst-kix_kamoyoh6ff6i-3>li:before{content:"-  "}.lst-kix_kamoyoh6ff6i-5>li:before{content:"-  "}ul.lst-kix_i9ogz79n8728-3{list-style-type:none}ul.lst-kix_i9ogz79n8728-2{list-style-type:none}.lst-kix_kamoyoh6ff6i-4>li:before{content:"-  "}.lst-kix_kamoyoh6ff6i-6>li:before{content:"-  "}ul.lst-kix_i9ogz79n8728-5{list-style-type:none}ul.lst-kix_i9ogz79n8728-4{list-style-type:none}ul.lst-kix_i9ogz79n8728-7{list-style-type:none}ul.lst-kix_i9ogz79n8728-6{list-style-type:none}ul.lst-kix_i9ogz79n8728-8{list-style-type:none}.lst-kix_kamoyoh6ff6i-8>li:before{content:"-  "}.lst-kix_kamoyoh6ff6i-7>li:before{content:"-  "}ul.lst-kix_6bma3c9v8hd3-3{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-7{list-style-type:none}.lst-kix_r3tj6hiinl4w-2>li:before{content:"-  "}ul.lst-kix_6bma3c9v8hd3-4{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-8{list-style-type:none}ul.lst-kix_6bma3c9v8hd3-1{list-style-type:none}.lst-kix_r3tj6hiinl4w-1>li:before{content:"-  "}.lst-kix_r3tj6hiinl4w-3>li:before{content:"-  "}ul.lst-kix_6bma3c9v8hd3-2{list-style-type:none}ul.lst-kix_6bma3c9v8hd3-0{list-style-type:none}.lst-kix_r3tj6hiinl4w-0>li:before{content:"-  "}.lst-kix_6bma3c9v8hd3-3>li:before{content:"-  "}.lst-kix_6bma3c9v8hd3-2>li:before{content:"-  "}ul.lst-kix_uudkrsvsf0zu-0{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-1{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-2{list-style-type:none}.lst-kix_6bma3c9v8hd3-0>li:before{content:"-  "}ul.lst-kix_6bma3c9v8hd3-7{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-3{list-style-type:none}ul.lst-kix_6bma3c9v8hd3-8{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-4{list-style-type:none}.lst-kix_6bma3c9v8hd3-1>li:before{content:"-  "}ul.lst-kix_6bma3c9v8hd3-5{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-5{list-style-type:none}ul.lst-kix_6bma3c9v8hd3-6{list-style-type:none}ul.lst-kix_uudkrsvsf0zu-6{list-style-type:none}.lst-kix_zd2jejnf7l80-3>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-2>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-1>li:before{content:"-  "}.lst-kix_kamoyoh6ff6i-0>li:before{content:"-  "}.lst-kix_zd2jejnf7l80-0>li:before{content:"-  "}.lst-kix_6bma3c9v8hd3-4>li:before{content:"-  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_6bma3c9v8hd3-5>li:before{content:"-  "}.lst-kix_6bma3c9v8hd3-6>li:before{content:"-  "}.lst-kix_i9ogz79n8728-0>li:before{content:"-  "}.lst-kix_6bma3c9v8hd3-7>li:before{content:"-  "}.lst-kix_6bma3c9v8hd3-8>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c8{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:146.2pt;border-top-color:#000000;border-bottom-style:solid}.c18{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:56.2pt;border-top-color:#000000;border-bottom-style:solid}.c12{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:170.2pt;border-top-color:#000000;border-bottom-style:solid}.c7{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:78pt;border-top-color:#000000;border-bottom-style:solid}.c16{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:112.9pt;border-top-color:#000000;border-bottom-style:solid}.c0{margin-left:72pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c19{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c1{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c27{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c29{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:24pt;font-family:"Arial";font-style:normal}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c26{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c22{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c24{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Arial";font-style:normal}.c14{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c6{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left;height:11pt}.c4{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c5{border-spacing:0;border-collapse:collapse;margin-right:auto}.c28{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;font-style:italic;text-decoration:underline}.c23{background-color:#ffffff;max-width:451.4pt;padding:72pt 72pt 72pt 72pt}.c30{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:underline}.c17{padding:0;margin:0}.c25{margin-left:108pt;padding-left:0pt}.c15{margin-left:144pt;padding-left:0pt}.c9{margin-left:36pt;padding-left:0pt}.c13{height:11pt}.c20{margin-left:72pt}.c10{font-weight:700}.c11{margin-left:36pt}.c21{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c23"><p class="c26 title" id="h.4c4oq0cibbdh"><span class="c29">Barrett Esophagus Whole Slide Image (WSI) patch extractor outline</span></p><p class="c6"><span>Outline of new patch extractor</span></p><h1 class="c19" id="h.m9dp7hywp37q"><span class="c22">Implementation</span></h1><p class="c6"><span class="c3">The pipeline to create patches from whole slide images can be split up into parts. This is a draft of the pipeline and things that should/could be included.</span></p><p class="c6 c13"><span class="c3"></span></p><h2 class="c14" id="h.pdi6h2hk5gpp"><span class="c27">Step 1: WSI &rarr; Biopsies</span></h2><p class="c6"><span class="c3">The first step is to extract biopsies from the tiff files and convert the xml annotations to masks. Inputs are the TIFF file with its corresponding XML file containing annotations for the N biopsies. Output for each of these files is N biopsies and masks.</span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span>class </span><span class="c10">WSI2Biopsies</span><span class="c3">(root_dir,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataset,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WSI_name,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_dir,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;annotation_classes_dict=ANNOTATION_CLASSES_DICT,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label_map=ANN2LABEL,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;magnification=20,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extract_stroma=False,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask_exclude=False,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verbose=True,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_fig=False):</span></p><p class="c6 c11"><span class="c3">&quot;&quot;&quot;Function to extract N biopsies and masks from TIFF file with its corresponding XML file with annotations.</span></p><p class="c6 c13 c11"><span class="c3"></span></p><p class="c6 c11"><span class="c3">Parameters:</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_dir (str): String with path to root directory of datasets.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataset (str): String with dataset name to extract files from.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WSI_name (str): String with path to tiff and xml files containing N biopsies for one WSI.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_dir (str): String with path to save biopsies and masks.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;annotation_classes_dict (dict): Dictionary of annotation groups based level of annotation to extract in XML files.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label_map (dict): Dictionary with label corresponding to annotation group.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;magnification (int): Integer at which magnification to the biopsies. Options are: [40, 20, 10, 5, ...].</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extract_stroma (bool): If set to True, stroma regions will be separated from background regions and be combined with E-Stroma class. If set to False, stroma and background regions will be combined into one label.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask_exclude (bool): If set to True, regions annotated with Exclude will be masked in the resulting images.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verbose (bool): If set to True, prints with progress updates will be made.</span></p><p class="c6 c13 c11"><span class="c3"></span></p><p class="c6 c11"><span class="c3">Returns:</span></p><p class="c6 c20"><span class="c3">biopsies (list): List of N biopsies</span></p><p class="c6 c20"><span class="c3">masks (list): List of N masks</span></p><p class="c6 c11"><span class="c3">&quot;&quot;&quot;</span></p><p class="c6 c13"><span class="c3"></span></p><h2 class="c14" id="h.2dyhf15qx7kd"><span class="c27">Step 2: Biopsies &rarr; Patches</span></h2><p class="c6"><span class="c3">The second step is to convert all biopsies and their corresponding masks into smaller patches. </span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span class="c3">class Biopsy2Patches(root_dir,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_dir,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;patch_size=(224, 224),</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stride=(224,224),</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threshold=0.15,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_patches=True,</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_gif=False):</span></p><p class="c6 c11"><span class="c3">&quot;&quot;&quot;Function to extract patches from single biopsy given the parameters.</span></p><p class="c6 c13 c11"><span class="c3"></span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Parameters:</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_dir (str): Root directory of biopsy containing biopsy.png, mask.png and exclude.png</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out_dir (str): Directory to store patches in.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;patch_size (tuple): Tuple for size of extracted patches. Resulting patches will have size of (H x W).</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stride (tuple): Tuple for stride of extracting patches in both vertical and horizontal direction (V_stride, H_stride).</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threshold (float): Patches with an area of Squamous, NDBE, LGD and HGD together larger than threshold are saved.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_patches (bool): If True, patches of biopsy and mask are save in biopsy_patches and mask_patches.</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_gif (bool): If True, a gif of all selected patches highlighted will be made for biopsy and mask</span></p><p class="c6 c13 c11"><span class="c3"></span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns:</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Saves patches of biopsy and mask in out_dir in folders biopsy_patches and mask_patches respectfully. Also creates dictionaries</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for patch level and biopsy level labels. &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c6 c11"><span class="c3">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span></p><p class="c6 c13"><span class="c3"></span></p><h2 class="c14" id="h.w2yy8evuu32n"><span class="c27">Step 3: Creating dataset files/splits</span></h2><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span class="c3">To be done&hellip;</span></p><h1 class="c19" id="h.dlztw2z9tfm4"><span>Datasets</span></h1><p class="c6"><span>Relevant </span><span class="c3">datasets on AMC servers (/data/archief/AMC-data/Barrett/):</span></p><ul class="c17 lst-kix_r3tj6hiinl4w-0 start"><li class="c6 c9 li-bullet-0"><span class="c3">ASL</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">N patients: 36</span></li><li class="c0 li-bullet-0"><span class="c3">prefix(es): &ldquo;ASLxx_K_HE&rdquo; (K is 3 or 1. difference?)</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">Bolero</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">N patients: 51</span></li><li class="c0 li-bullet-0"><span class="c3">prefix(es): &ldquo;RB00xx_HE&rdquo;</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">LANS</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">N patients: 34</span></li><li class="c0 li-bullet-0"><span class="c3">prefix(es): &ldquo;RLxxx_0x_ox_ox_HE&rdquo; (last three x can be 1-5; meaning?)</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">LANS-Tissue</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">N patients: 42</span></li><li class="c0 li-bullet-0"><span class="c3">prefix(es): &ldquo;RLxxx_0x_ox_ox_HE&rdquo; (last three x can be 1-7; meaning?)</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">RBE</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">N patients: 187</span></li><li class="c0 li-bullet-0"><span class="c3">prefix(es): &ldquo;RBE-00xxx_HE&rdquo;, &ldquo;RBET17-xxxxx_HE_r&rdquo;, &ldquo;RBET18-xxxxx_HE-r_BIG&rdquo; &nbsp;&ldquo;ROCTxx_r-HEx&rdquo; (last x is number). r is Roman Numeral</span></li><li class="c0 li-bullet-0"><span class="c3">Note: Missing xml P53 staining for &ldquo;RBE-00121_P53.tiff&rdquo;, &ldquo;RBE-00123_P53.tiff&rdquo;, &ldquo;RBE-00124_P53.tiff&rdquo;</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">RBE_Nieuw</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">N patients: 25</span></li><li class="c0 li-bullet-0"><span class="c3">prefix(es): &ldquo;RBE-00xxx_HE&rdquo;</span></li></ul><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span>Datasets to exclude:</span></p><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">Maastricht- OLD_DATA</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span class="c3">DO NOT INCLUDE</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-0"><li class="c6 c9 li-bullet-0"><span class="c3">temp:</span></li></ul><ul class="c17 lst-kix_r3tj6hiinl4w-1 start"><li class="c0 li-bullet-0"><span>DO NOT INCLUDE: Seems to be subset of RBE</span></li></ul><p class="c6 c13"><span class="c24"></span></p><h1 class="c19" id="h.djb6kemt5mao"><span class="c22">Structure</span></h1><p class="c6"><span class="c3">We build our whole dataset by combining all of the above datasets. We want for our final dataset to be structured according to dataset, patients, biopsies and patches to be flexible. This also allows us to balance subsets according to labels and to split the dataset into train/validation/test independent of dataset and patients. </span></p><p class="c6 c13"><span class="c3"></span></p><ul class="c17 lst-kix_6bma3c9v8hd3-0 start"><li class="c6 c9 li-bullet-0"><span class="c3">Dataset (ASL, LANS, etc...)</span></li></ul><ul class="c17 lst-kix_6bma3c9v8hd3-1 start"><li class="c0 li-bullet-0"><span class="c3">WSI_ID</span></li></ul><ul class="c17 lst-kix_6bma3c9v8hd3-2 start"><li class="c6 c25 li-bullet-0"><span class="c3">Biopsies</span></li></ul><ul class="c17 lst-kix_6bma3c9v8hd3-3 start"><li class="c6 c15 li-bullet-0"><span class="c3">Patches</span></li></ul><p class="c6"><span class="c3">Patch data can be stored in several ways. We could store all patches as individual png files or (preferably) combine patches into larger files such as HDF5 files for faster I/O operations.</span></p><h1 class="c19" id="h.jbo18br4jt03"><span class="c22">Labels</span></h1><p class="c6"><span class="c3">Labels are important for training down-stream tasks and also balancing our dataset. We want to collect individual labels per patch. Also, for future use we want to collect labels on biopsy and WSI_ID level.</span></p><h2 class="c14" id="h.oqhvhri4wqnp"><span class="c27">Annotation classes in tiff:</span></h2><p class="c6"><span>Each tiff file has a corresponding xml file with annotations. Annotations can be on a Glandular and Tissue level which is indicated by -G and -T respectively. The following annotations are used:</span></p><ul class="c17 lst-kix_i9ogz79n8728-0 start"><li class="c6 c9 li-bullet-0"><span class="c10">Biopsy-Outlines</span><span class="c3">: Outlines of biopsies defined by 4 coordinates. One WSI can contain several biopts</span></li></ul><ul class="c17 lst-kix_zd2jejnf7l80-0 start"><li class="c6 c9 li-bullet-0"><span class="c10">Squamous(-G? and -T)</span><span>: Squamous epithelium. (By definition only -T?)</span></li><li class="c6 c9 li-bullet-0"><span class="c10">NDBE(-G and -T)</span><span class="c3">: non-dysplastic Barrett&rsquo;s esophagus tissue</span></li><li class="c6 c9 li-bullet-0"><span class="c10">LGD(-G and -T)</span><span class="c3">: Low-grade dysplasia</span></li><li class="c6 c9 li-bullet-0"><span class="c10">HGD(-G and -T)</span><span class="c3">: High-grade dysplasia</span></li><li class="c6 c9 li-bullet-0"><span class="c10">E-Stroma</span><span class="c3">: Tissue which lies in area between glandular structures</span></li><li class="c6 c9 li-bullet-0"><span class="c10">Exclude</span><span>: Regions of tissue which are excluded for several reasons. </span><span class="c30">IMPORTANT: </span><span>regions within areas annotated as Exclude </span><span class="c28">can</span><span class="c3">&nbsp;contain other annotations.</span></li></ul><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span class="c3">There is also some tissue which is not annotated but is (maybe) still relevant to distinguish between: </span></p><ul class="c17 lst-kix_uudkrsvsf0zu-0 start"><li class="c6 c9 li-bullet-0"><span class="c10">Background</span><span class="c3">: Area which lies within Biopsy-Outlines and contains no tissue</span></li></ul><ul class="c17 lst-kix_zd2jejnf7l80-0"><li class="c6 c9 li-bullet-0"><span class="c10">Unannotated stroma: </span><span class="c3">Tissue which lies within Biopsy-Outlines but has no further annotation (This tissue has no annotation in the datasets because it is deemed diagnostically less relevant).</span></li><li class="c6 c9 li-bullet-0"><span class="c10">Out of bounds (OOB) exclude</span><span>: Tissue which lies outside of the Biopsy-Outlines annotations. This tissue is excluded as well</span></li></ul><h2 class="c14" id="h.2v2s2nyoyzhe"><span>Annotation classes to Labels</span><span class="c27">:</span></h2><p class="c6"><span class="c3">Some of these annotations can be turned directly into labels but others need to be constructed (e.g. background). Labels are stored as masks and some other special labels are constructed. </span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span class="c3">The table below shows the definitions of labels from annotations. Background and stroma are seen as one labeled class but could also be interpreted as two different labels. </span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p><a id="t.45eb2fef64bdb0950eb736546944e832f8f26a57"></a><a id="t.0"></a><table class="c5"><tbody><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c1">Label_id</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c1">Label_name</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c1">Corresp. Ann.</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span class="c1">Remarks</span></p></td></tr><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c3">0</span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c4"><span class="c3">???</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c3">Background</span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c4"><span class="c3">Stroma</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c3">Biopsy-Outlines + No Tissue</span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c2"><span class="c3"></span></p><p class="c4"><span class="c3">E-Stroma or Biopsy-Outlines + Tissue</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span>Background and Stroma can be separate or combined classes. </span><span class="c28">Argument for splitting:</span><span class="c3">&nbsp;One has tissue and other does not. Combining them could lead to confusion if the sampled patch contains only stroma in real world application.</span></p><p class="c4"><span class="c28">Argument against splitting: </span><span class="c3">Stroma is diagnostically not really relevant. By splitting them, labels will get cluttered and training resources will be devoted to less relevant labels </span></p></td></tr><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c3">1</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c3">Squamous</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c3">Squamous-T</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span class="c3">- </span></p></td></tr><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c3">2</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c3">NDBE</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c3">NDBE-G or NDBE-T</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span class="c3">Combine Glandular/Tissue level annotations into one.</span></p></td></tr><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c3">3</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c3">LGD</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c3">LGD-G or LGD-T</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span class="c3">Combine Glandular/Tissue level annotations into one.</span></p></td></tr><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c3">4</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c3">HGD</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c3">HGD-G or HGD-T</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span class="c3">Combine Glandular/Tissue level annotations into one.</span></p></td></tr><tr class="c21"><td class="c18" colspan="1" rowspan="1"><p class="c4"><span class="c3">-1</span></p></td><td class="c7" colspan="1" rowspan="1"><p class="c4"><span class="c3">Exclude</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c4"><span class="c3">Exclude</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c4"><span class="c3">Excluded areas do not really contain a label. A separate mask can be created which can be either applied or not on patches.</span></p></td></tr></tbody></table><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p><p class="c6"><span class="c3">Besides creating masks used for segmentation tasks, some other special labels can be collected and stored. These labels can be used for different down-stream tasks and can be over on different levels besides patch level. Some of these labels are:</span></p><ul class="c17 lst-kix_kamoyoh6ff6i-0 start"><li class="c6 c9 li-bullet-0"><span class="c3">Center pixel label of Patch</span></li><li class="c6 c9 li-bullet-0"><span class="c3">Area (in pixels or ratio) of each label in Patch, Biopsy and WSI/Patient separately</span></li><li class="c6 c9 li-bullet-0"><span class="c3">Single label for Patch, Biopsy and WSI/Patient separately according to highest priority label (HGD &gt; LGD &gt; NDBE &gt; Squamous &gt;= Stroma or Background)</span></li></ul><p class="c6 c13"><span class="c3"></span></p><h1 class="c19" id="h.tepfaaoqxtdk"><span class="c22">Magnification</span></h1><p class="c6"><span class="c3">TIFFs have several zoom levels stored within them. Zoom level 0 is &lsquo;40x&rsquo;, which is 0.25 mu/pixel (4 pixels per mu). Below is a table with zoom levels and their corresponding scales.</span></p><p class="c6 c13"><span class="c3"></span></p><a id="t.5cc9390f549599023f985f4b438b55d218ab0857"></a><a id="t.1"></a><table class="c5"><tbody><tr class="c21"><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c1">Level</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c1">Zoom</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c1">mu/pixels</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c1">pixels/mu</span></p></td></tr><tr class="c21"><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">0</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">40x</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">0.25</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">4</span></p></td></tr><tr class="c21"><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">1</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">20x</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">0.5</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">2</span></p></td></tr><tr class="c21"><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">2</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">10x</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">1</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">1</span></p></td></tr><tr class="c21"><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">3</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">5x</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">2</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">0.5</span></p></td></tr><tr class="c21"><td class="c16" colspan="1" rowspan="1"><p class="c4"><span class="c3">etc&hellip;</span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c2"><span class="c3"></span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c2"><span class="c3"></span></p></td><td class="c16" colspan="1" rowspan="1"><p class="c2"><span class="c3"></span></p></td></tr></tbody></table><p class="c6 c13"><span class="c3"></span></p><p class="c6 c13"><span class="c3"></span></p></body></html>

